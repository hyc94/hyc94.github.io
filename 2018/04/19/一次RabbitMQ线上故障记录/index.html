<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>一次RabbitMQ线上故障记录 | Hyc的博客</title><meta name="description" content=""><meta name="keywords" content=""><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/"><link rel="alternate" href="/atom.xml" title="Hyc的博客"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="今天在线上环境中出现了一个很奇怪的RabbitMQ故障，特意记录下。  出现现象 排查过程 事后分析"><meta name="keywords" content="mq"><meta property="og:type" content="article"><meta property="og:title" content="一次RabbitMQ线上故障记录"><meta property="og:url" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/index.html"><meta property="og:site_name" content="Hyc的博客"><meta property="og:description" content="今天在线上环境中出现了一个很奇怪的RabbitMQ故障，特意记录下。  出现现象 排查过程 事后分析"><meta property="og:locale" content="default"><meta property="og:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-1.png"><meta property="og:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-2.png"><meta property="og:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-3.png"><meta property="og:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-4.png"><meta property="og:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-5.png"><meta property="og:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-6.png"><meta property="og:updated_time" content="2018-11-21T13:37:20.475Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一次RabbitMQ线上故障记录"><meta name="twitter:description" content="今天在线上环境中出现了一个很奇怪的RabbitMQ故障，特意记录下。  出现现象 排查过程 事后分析"><meta name="twitter:image" content="http://yoursite.com/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-1.png"><link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet"><link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet"><link rel="stylesheet" href="/style.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script></head></html><body><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>setLoadingBarProgress(20)</script><header class="l_header"><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="/">Hyc的博客</a><div class="menu"><ul class="h-list"><li><a class="flat-box nav-home" href="/">Home</a></li><li><a class="flat-box nav-archives" href="/archives">Archives</a></li></ul><div class="underline"></div></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="Search"> <span class="icon icon-search"></span></form></div><ul class="switcher h-list"><li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li><li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo" href="javascript:void(0)">Word of Forks</a><ul class="switcher h-list"><li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li><li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li><li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li></ul></div></div></header><aside class="menu-phone"><nav><a href="/" class="nav-home nav">Home </a><a href="/archives" class="nav-archives nav">Archives</a></nav></aside><script>setLoadingBarProgress(40)</script><div class="l_body"><div class="container clearfix"><div class="l_main"><article id="post-一次RabbitMQ线上故障记录" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><h2 class="title"><a href="/2018/04/19/一次RabbitMQ线上故障记录/">一次RabbitMQ线上故障记录</a></h2><time>Apr 19, 2018</time><div class="cats"><a href="/categories/运维/">运维</a></div></section><section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#出现原因"><span class="toc-number">1.</span> <span class="toc-text">出现原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排查过程"><span class="toc-number">2.</span> <span class="toc-text">排查过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查找日志"><span class="toc-number">2.1.</span> <span class="toc-text">查找日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误定位"><span class="toc-number">2.2.</span> <span class="toc-text">错误定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理办法"><span class="toc-number">2.3.</span> <span class="toc-text">处理办法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事后分析"><span class="toc-number">3.</span> <span class="toc-text">事后分析</span></a></li></ol></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><p>今天在线上环境中出现了一个很奇怪的RabbitMQ故障，特意记录下。</p><ul><li>出现现象</li><li>排查过程</li><li>事后分析</li></ul><hr><a id="more"></a><h2 id="出现原因"><a href="#出现原因" class="headerlink" title="出现原因"></a>出现原因</h2><p>由于公司有一个老版本系统在运维，是部署在Windows Server2012的环境上。今天这个系统出现了异常，关于队列有关的功能出现了不可用。因为该系统架构以及代码都比较老旧，而且正在逐步停止运维，定位问题难度比较高。</p><p>具体现象如下：当运维人员发现系统出现异常后，重启了系统，但是还是没有效果。然后查看消息队列RabbitMQ的状态，发现处于停止状态，随后启动RabbitMQ，回到系统一看发现还是不可用。查看系统日志后发现还是无法连接队列，多次启动RabbitMQ，最后发现RabbitMQ无法启动。</p><h2 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h2><h3 id="查找日志"><a href="#查找日志" class="headerlink" title="查找日志"></a>查找日志</h3><p>由于多次启动RabbitMQ失败，所以去查看RabbitMQ日志，由于安装RabbitMQ时并未改变日志路径，所以日志输出在默认路径 %APPDATA%\RabbitMQ。<br><a href="https://www.rabbitmq.com/relocate.html" target="_blank" rel="noopener">https://www.rabbitmq.com/relocate.html</a><br><img src="/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-1.png" title="一次RabbitMQ线上故障记录"></p><h3 id="错误定位"><a href="#错误定位" class="headerlink" title="错误定位"></a>错误定位</h3><p>看日志时发现日志文件已经有600M，无法用Notepad++等工具打开，然后暂时删除日志文件，重启RabbitMQ希望重现问题抓取日志，但是操作几次后从新的日志文件看不出问题。<br>偶然查看磁盘空间，发现剩余0%（0字节可用），因为这台服务器是租用阿里云的资源，磁盘空间有限，可能由于一些不恰当的操作，导致服务器磁盘。<br>删除一些无效文件，使磁盘有空余空间，然后重启RabbitMQ服务，但是查看5672端口还是没有监听。</p><p>因为从Windows服务启动信息不够，暂时先从命令行启动查看，发现错误信息如下：<br><img src="/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-2.png" title="一次RabbitMQ线上故障记录"></p><h3 id="处理办法"><a href="#处理办法" class="headerlink" title="处理办法"></a>处理办法</h3><p>由于recovery.dets文件无法加载，导致RabbitMQ无法启动。为了能让系统可用，暂时先删除recovery.dets文件，然后启动RabbitMQ恢复正常。<br><img src="/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-3.png" title="一次RabbitMQ线上故障记录"></p><h2 id="事后分析"><a href="#事后分析" class="headerlink" title="事后分析"></a>事后分析</h2><p>查看官方文档，关于RabbitMQ的数据存储：<br>RabbitMQ从3.7.0版本开始所有的消息数据到放在msg_stores/vhosts目录下，每个vhost单独放在一个子目录，每个子目录以 (vhost名字+哈希值).vhost命名，每个vhost分开存储。<br>在3.7.0以前，所有的消息都存在以下几个目录中：queues, msg_store_persistent和msg_store_transient。而且如果正常关机的话，是由recovery.dets文件来恢复元数据。<br><img src="/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-4.png" title="一次RabbitMQ线上故障记录"></p><p>下载之前太大的日志，仔细查看ERROR日志，发现如下错误：<br><img src="/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-5.png" title="一次RabbitMQ线上故障记录"><br><img src="/2018/04/19/一次RabbitMQ线上故障记录/一次RabbitMQ线上故障记录-6.png" title="一次RabbitMQ线上故障记录"></p><p>应该是RabbitMQ在关闭时，将队列中的数据写入recovery.dets文件时由于磁盘空间不足，导致文件出现损坏（被删除的recovery.dets文件大小为0），然后RabbitMQ启动时无法从recovery.dets文件获取元数据，所以启动失败。</p></div><div class="article-tags tags"><a href="/tags/mq/">mq</a></div><div class="art-item-footer"><span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/2018/09/10/直面Java-面向对象1/" rel="prev" title="直面Java-面向对象1"> 直面Java-面向对象1 </a></span><span class="art-item-right">next：<a href="/2018/01/20/kubernetes安装/" rel="next" title="使用kubeadm安装Kubernetes"> 使用kubeadm安装Kubernetes </a><i class="icon icon-chevron-thin-right"></i></span></div></section></article><script>window.subData={title:"一次RabbitMQ线上故障记录",tools:!0}</script></div><aside class="l_side"><section class="m_widget about"><div class="header">Hyc</div><div class="content"><div class="desc">Tempora mutantur, nos et mutamur in illis ...</div></div></section><section class="m_widget links"><div class="header">Links</div><div class="content"><ul class="entry"></ul></div></section><section class="m_widget categories"><div class="header">Categories</div><div class="content"><ul class="entry"><li><a class="flat-box" href="/categories/前端/"><div class="name">前端</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/categories/后端/"><div class="name">后端</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/categories/运维/"><div class="name">运维</div><div class="badget">2</div></a></li></ul></div></section><div class="m_widget tagcloud"><div class="header">Tags</div><div class="content"><a href="/tags/Java/" style="font-size:14px;color:grey">Java</a> <a href="/tags/JavaScript/" style="font-size:14px;color:grey">JavaScript</a> <a href="/tags/devops/" style="font-size:14px;color:grey">devops</a> <a href="/tags/mq/" style="font-size:14px;color:grey">mq</a></div></div></aside><script>setLoadingBarProgress(60)</script></div></div><footer id="footer" class="clearfix"><div class="social-wrapper"><a href="https://github.com/stkevintan" class="social github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="icon icon-rss"></span></a></div><div>Theme <a href="https://github.com/stkevintan/hexo-theme-material-flow" class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div></footer><script>setLoadingBarProgress(80)</script><script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script><script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script><script src="/js/jquery.fitvids.js"></script><script>var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo",ROOT="/";ROOT.endsWith("/")||(ROOT+="/")</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>setLoadingBarProgress(100)</script></body>